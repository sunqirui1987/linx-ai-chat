# èº«ä»½åˆ‡æ¢åŠŸèƒ½è¯´æ˜

## æ¦‚è¿°
æœ¬AIå¯¹è¯æ¸¸æˆæ”¯æŒåœ¨"å¤©ä½¿ä¸ƒå´½"å’Œ"æ¶é­”ä¸ƒå´½"ä¸¤ç§äººæ ¼ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œæ¯ç§äººæ ¼éƒ½æœ‰ç‹¬ç‰¹çš„æ€§æ ¼ç‰¹å¾ã€å¯¹è¯é£æ ¼å’Œè§†è§‰è¡¨ç°ã€‚

## äººæ ¼é…ç½®

### å¤©ä½¿ä¸ƒå´½ (angel)
- **åç§°**: å¤©ä½¿ä¸ƒå´½
- **ç‰¹å¾**: çº¯æ´å–„è‰¯ï¼Œæ¸©æš–æ²»æ„ˆ
- **çŠ¶æ€**: "æˆ‘ä¼šç”¨çˆ±ä¸æ¸©æš–é™ªä¼´ä½ "
- **æ€è€ƒæ–‡æœ¬**: "å¤©ä½¿æ­£åœ¨æ¸©æŸ”åœ°æ€è€ƒ..."
- **è§†è§‰é£æ ¼**: è“è‰²ä¸»é¢˜ï¼Œå¿ƒå½¢å›¾æ ‡
- **æ¬¢è¿è¯­**: "æ¬¢è¿ä½ ï¼Œäº²çˆ±çš„æœ‹å‹ã€‚æˆ‘ä¼šç”¨çˆ±ä¸å…‰æ˜é™ªä¼´ä½ çš„æ¯ä¸€åˆ»ã€‚"

### æ¶é­”ä¸ƒå´½ (demon)
- **åç§°**: æ¶é­”ä¸ƒå´½
- **ç‰¹å¾**: è¯±æƒ‘é‚ªæ¶ï¼Œå……æ»¡é­…åŠ›
- **çŠ¶æ€**: "å˜¿å˜¿ï¼Œæƒ³è¦ä»€ä¹ˆåˆºæ¿€çš„ä½“éªŒå—ï¼Ÿ"
- **æ€è€ƒæ–‡æœ¬**: "æ¶é­”æ­£åœ¨ç­–åˆ’ç€ä»€ä¹ˆ..."
- **è§†è§‰é£æ ¼**: çº¢è‰²ä¸»é¢˜ï¼Œé—ªç”µå›¾æ ‡
- **æ¬¢è¿è¯­**: "å˜¿å˜¿ï¼Œæ¬¢è¿æ¥åˆ°é»‘æš—çš„ä¸–ç•Œ...æƒ³è¦ä½“éªŒä¸€äº›åˆºæ¿€çš„ä¸œè¥¿å—ï¼Ÿ"

## åˆ‡æ¢æ–¹å¼

### 1. æ‰‹åŠ¨åˆ‡æ¢
**ä½ç½®**: é¡µé¢é¡¶éƒ¨HeaderåŒºåŸŸçš„äººæ ¼åˆ‡æ¢æŒ‰é’®ï¼ˆShuffleå›¾æ ‡ï¼‰

**æ“ä½œæ­¥éª¤**:
1. ç‚¹å‡»Headerå³ä¾§çš„äººæ ¼åˆ‡æ¢æŒ‰é’®ï¼ˆğŸ”€å›¾æ ‡ï¼‰
2. åœ¨ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ç›®æ ‡äººæ ¼
3. ç³»ç»Ÿä¼šæ˜¾ç¤ºåˆ‡æ¢åŠ¨ç”»å’Œé€šçŸ¥

**ä»£ç å®ç°**:
```typescript
// Header.vue ä¸­çš„åˆ‡æ¢æ–¹æ³•
const selectPersonality = (personality: string) => {
  if (personality !== props.currentPersonality) {
    emit('personalityChange', personality)
    
    const config = personalityOptions.find(p => p.key === personality)
    personalityChangeNotification.value = {
      message: `å·²åˆ‡æ¢åˆ°${config?.name || 'æœªçŸ¥'}æ¨¡å¼`,
      type: 'success'
    }
    
    setTimeout(() => {
      personalityChangeNotification.value = null
    }, 3000)
  }
  
  showPersonalitySelector.value = false
}
```

### 2. è‡ªåŠ¨åˆ‡æ¢ï¼ˆæ™ºèƒ½åˆ‡æ¢ï¼‰
**è§¦å‘æ¡ä»¶**: åŸºäºç”¨æˆ·æƒ…ç»ªåˆ†æå’Œå¯¹è¯å†…å®¹

**åˆ‡æ¢é€»è¾‘**:
- **æ¶ˆææƒ…ç»ª** â†’ åˆ‡æ¢åˆ°å¤©ä½¿å½¢æ€æä¾›å®‰æ…°
- **ä¾èµ–å€¾å‘** â†’ åˆ‡æ¢åˆ°å¤©ä½¿å½¢æ€é™ªä¼´
- **æŠ€æœ¯è®¨è®º** â†’ åˆ‡æ¢åˆ°æŠ€æœ¯å½¢æ€
- **æŒ‘è¡…æƒ…ç»ª** â†’ åˆ‡æ¢åˆ°æ¶é­”å½¢æ€åº”å¯¹
- **ç§¯ææƒ…ç»ª** â†’ ä¿æŒæˆ–åˆ‡æ¢åˆ°å¤©ä½¿å½¢æ€

**ä»£ç å®ç°**:
```typescript
// personality.ts ä¸­çš„æ™ºèƒ½åˆ‡æ¢
async smartSwitch(emotionResult: any, context?: any, sessionId?: string): Promise<PersonalitySwitchResult | null> {
  // æ£€æŸ¥å†·å´æ—¶é—´
  if (this.isInCooldown()) {
    return null
  }

  try {
    // è°ƒç”¨åç«¯äººæ ¼æ¨èAPI
    const response = await apiClient.post('/personality/recommend', {
      emotion: emotionResult,
      content: context?.content || '',
      sessionId: sessionId || 'default',
      currentPersonality: this.currentPersonality
    })

    const recommendations = response.data as Array<{
      personality: string
      score: number
      reason: string
      confidence: number
    }>

    // æ‰¾åˆ°æœ€ä½³æ¨è
    const bestRecommendation = recommendations.find(rec => 
      rec.personality !== this.currentPersonality && rec.score > 0.6
    )

    if (!bestRecommendation) {
      return null
    }

    // æ‰§è¡Œæ™ºèƒ½åˆ‡æ¢
    return await this.switchPersonality(
      bestRecommendation.personality,
      `æ™ºèƒ½åˆ‡æ¢ï¼š${bestRecommendation.reason}`,
      sessionId
    )
  } catch (error) {
    console.error('æ™ºèƒ½äººæ ¼åˆ‡æ¢å¤±è´¥:', error)
    return null
  }
}
```

### 3. Socketå®æ—¶åˆ‡æ¢
**åŠŸèƒ½**: æ”¯æŒé€šè¿‡WebSocketè¿›è¡Œå®æ—¶äººæ ¼åˆ‡æ¢

**ä»£ç å®ç°**:
```typescript
// socket.ts ä¸­çš„åˆ‡æ¢æ–¹æ³•
switchPersonality(personality: string, reason?: string) {
  if (!this.isConnected || !this.socket) return

  this.socket.emit('personality:switch', {
    personality,
    reason
  })
}
```

## åˆ‡æ¢æ•ˆæœ

### 1. è§†è§‰æ•ˆæœ
- **åˆ‡æ¢åŠ¨ç”»**: å…¨å±ç²’å­æ•ˆæœåŠ¨ç”»ï¼ˆPersonalitySwitchAnimation.vueï¼‰
- **ä¸»é¢˜å˜åŒ–**: é¢œè‰²ä¸»é¢˜ä»è“è‰²ï¼ˆå¤©ä½¿ï¼‰åˆ‡æ¢åˆ°çº¢è‰²ï¼ˆæ¶é­”ï¼‰
- **å›¾æ ‡å˜åŒ–**: å¿ƒå½¢å›¾æ ‡ â†” é—ªç”µå›¾æ ‡
- **å¤´åƒæ ·å¼**: è¾¹æ¡†å’ŒèƒŒæ™¯è‰²ç›¸åº”å˜åŒ–

### 2. éŸ³æ•ˆæ•ˆæœ
- **åˆ‡æ¢éŸ³æ•ˆ**: ä¸åŒäººæ ¼æœ‰ä¸“å±çš„åˆ‡æ¢éŸ³æ•ˆ
- **ç¯å¢ƒéŸ³**: æ¯ç§äººæ ¼æœ‰å¯¹åº”çš„èƒŒæ™¯ç¯å¢ƒéŸ³
- **è¯­éŸ³æ’­æ”¾**: æ”¯æŒTTSè¯­éŸ³æ’­æ”¾ï¼Œå£°éŸ³ç‰¹å¾åŒ¹é…äººæ ¼

### 3. é€šçŸ¥æç¤º
- **Toasté€šçŸ¥**: æ˜¾ç¤ºåˆ‡æ¢æˆåŠŸçš„æç¤ºä¿¡æ¯
- **çŠ¶æ€æ›´æ–°**: HeaderåŒºåŸŸå®æ—¶æ›´æ–°å½“å‰äººæ ¼ä¿¡æ¯
- **å†å²è®°å½•**: è®°å½•åˆ‡æ¢å†å²å’ŒåŸå› 

## è®¾ç½®é€‰é¡¹

### è‡ªåŠ¨åˆ‡æ¢è®¾ç½®
**ä½ç½®**: è®¾ç½®é¢æ¿ â†’ äººæ ¼è®¾ç½®

**å¯é…ç½®é¡¹**:
- **è‡ªåŠ¨åˆ‡æ¢äººæ ¼**: å¼€å¯/å…³é—­æ™ºèƒ½åˆ‡æ¢åŠŸèƒ½
- **æƒ…ç»ªæ„ŸçŸ¥**: æ§åˆ¶æƒ…ç»ªåˆ†æçš„æ•æ„Ÿåº¦
- **åˆ‡æ¢å†·å´æ—¶é—´**: é˜²æ­¢é¢‘ç¹åˆ‡æ¢çš„æ—¶é—´é—´éš”

**ä»£ç å®ç°**:
```typescript
// SettingsPanel.vue ä¸­çš„è®¾ç½®
<div class="flex items-center justify-between">
  <label class="text-sm text-gray-300">è‡ªåŠ¨åˆ‡æ¢äººæ ¼</label>
  <button
    @click="settings.personality.autoSwitch = !settings.personality.autoSwitch; updatePersonalitySettings()"
    class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
    :class="settings.personality.autoSwitch ? 'bg-pink-600' : 'bg-gray-600'"
  >
    <span
      class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
      :class="settings.personality.autoSwitch ? 'translate-x-6' : 'translate-x-1'"
    />
  </button>
</div>
```

## æŠ€æœ¯å®ç°

### 1. çŠ¶æ€ç®¡ç†
- **Pinia Store**: ä½¿ç”¨chatStoreç®¡ç†å½“å‰äººæ ¼çŠ¶æ€
- **æœ¬åœ°å­˜å‚¨**: äººæ ¼çŠ¶æ€æŒä¹…åŒ–åˆ°localStorage
- **ä¼šè¯å…³è”**: æ¯ä¸ªèŠå¤©ä¼šè¯è®°å½•äººæ ¼åˆ‡æ¢å†å²

### 2. APIæ¥å£
- **åˆ‡æ¢æ¥å£**: `POST /personality/switch`
- **æ¨èæ¥å£**: `POST /personality/recommend`
- **å†å²æ¥å£**: `GET /personality/sessions/{sessionId}/switches`

### 3. ç»„ä»¶æ¶æ„
- **PersonalityManager**: æ ¸å¿ƒäººæ ¼ç®¡ç†ç±»
- **Header.vue**: æ‰‹åŠ¨åˆ‡æ¢UIç»„ä»¶
- **PersonalitySwitchAnimation.vue**: åˆ‡æ¢åŠ¨ç”»ç»„ä»¶
- **personality.ts**: äººæ ¼é…ç½®å’Œå·¥å…·å‡½æ•°

## ä½¿ç”¨ç¤ºä¾‹

### æ‰‹åŠ¨åˆ‡æ¢ç¤ºä¾‹
```typescript
// åœ¨ç»„ä»¶ä¸­è§¦å‘äººæ ¼åˆ‡æ¢
const handlePersonalityChange = (personality: string) => {
  previousPersonality.value = chatStore.currentPersonality
  chatStore.currentPersonality = personality
  
  // æ’­æ”¾åˆ‡æ¢éŸ³æ•ˆ
  if (personality === 'demon') {
    playSound('switchToDemon')
  } else if (personality === 'angel') {
    playSound('switchToAngel')
  }
  
  // æ˜¾ç¤ºåˆ‡æ¢åŠ¨ç”»
  showPersonalitySwitchAnimation.value = true
  
  // åˆ‡æ¢ä¸»é¢˜
  switchPersonality(personality as 'demon' | 'angel' | 'neutral')
  
  // æ’­æ”¾è§’è‰²ç¯å¢ƒéŸ³
  playPersonalityAmbient(personality as 'demon' | 'angel' | 'neutral')
  
  const personalityNames = {
    'demon': 'æ¶é­”',
    'angel': 'å¤©ä½¿',
    'neutral': 'ä¸­æ€§'
  }
  showNotification('info', `ğŸ”„ å·²åˆ‡æ¢åˆ°${personalityNames[personality as keyof typeof personalityNames] || personality}äººæ ¼`)
}
```

### æ™ºèƒ½åˆ‡æ¢ç¤ºä¾‹
```typescript
// åŸºäºæƒ…ç»ªåˆ†æçš„è‡ªåŠ¨åˆ‡æ¢
const emotionResult = await analyzeEmotion(userMessage)
const switchResult = await personalityManager.smartSwitch(
  emotionResult,
  { content: userMessage },
  currentSessionId
)

if (switchResult && switchResult.success) {
  console.log(`äººæ ¼å·²åˆ‡æ¢: ${switchResult.fromPersonality} â†’ ${switchResult.toPersonality}`)
  console.log(`åˆ‡æ¢åŸå› : ${switchResult.reason}`)
}
```

## æ³¨æ„äº‹é¡¹

1. **å†·å´æœºåˆ¶**: ä¸ºé˜²æ­¢é¢‘ç¹åˆ‡æ¢ï¼Œè®¾ç½®äº†å†·å´æ—¶é—´é™åˆ¶
2. **æƒé™æ§åˆ¶**: æŸäº›æƒ…å†µä¸‹å¯èƒ½é™åˆ¶åˆ‡æ¢ï¼ˆå¦‚ç‰¹å®šå¯¹è¯åœºæ™¯ï¼‰
3. **çŠ¶æ€åŒæ­¥**: ç¡®ä¿å‰åç«¯äººæ ¼çŠ¶æ€ä¿æŒä¸€è‡´
4. **ç”¨æˆ·ä½“éªŒ**: åˆ‡æ¢è¿‡ç¨‹ä¸­æä¾›æ¸…æ™°çš„è§†è§‰å’Œå¬è§‰åé¦ˆ
5. **é”™è¯¯å¤„ç†**: åˆ‡æ¢å¤±è´¥æ—¶æœ‰ç›¸åº”çš„é”™è¯¯æç¤ºå’Œå›é€€æœºåˆ¶

## æ‰©å±•æ€§

ç³»ç»Ÿè®¾è®¡æ”¯æŒæœªæ¥æ·»åŠ æ›´å¤šäººæ ¼ç±»å‹ï¼Œåªéœ€è¦ï¼š
1. åœ¨`personality.ts`ä¸­æ·»åŠ æ–°çš„äººæ ¼é…ç½®
2. æ›´æ–°ç›¸å…³çš„UIç»„ä»¶å’Œæ ·å¼
3. æ‰©å±•åç«¯çš„äººæ ¼æ¨èé€»è¾‘
4. æ·»åŠ å¯¹åº”çš„éŸ³æ•ˆå’ŒåŠ¨ç”»æ•ˆæœ