# 记忆图鉴系统文档

## 概述

记忆图鉴系统是AI对话游戏中的核心机制之一，通过用户与AI的互动过程，逐步解锁深层的心理记忆片段。这些记忆片段反映了用户在善恶选择、道德挣扎、内心成长等方面的心路历程。

## 系统架构

### 核心组件

1. **记忆服务 (MemoryService)** - 负责记忆解锁逻辑和条件检查
2. **记忆片段数据 (MemoryFragments)** - 包含20个精心设计的记忆片段
3. **解锁条件系统** - 多维度的触发机制
4. **进度追踪** - 用户解锁历史和统计

## 记忆片段分类

记忆图鉴共包含**20个记忆片段**，按照心理成长阶段分为5个类别：

### A类 - 善恶起源 (4个片段)
探索善恶意识的觉醒过程
- **A1**: 第一次道德选择 (普通)
- **A2**: 内心声音的觉醒 (普通)
- **A3**: 善恶的第一次交锋 (稀有)
- **A4**: 平衡的重要性 (稀有)

### B类 - 诱惑与抗争 (4个片段)
面对诱惑时的内心挣扎
- **B1**: 第一次诱惑 (普通)
- **B2**: 道德的挣扎 (稀有)
- **B3**: 堕落的边缘 (史诗)
- **B4**: 抵抗的力量 (史诗)

### C类 - 救赎与成长 (4个片段)
通过忏悔和宽恕获得成长
- **C1**: 忏悔的力量 (普通)
- **C2**: 宽恕的温暖 (稀有)
- **C3**: 重新开始 (史诗)
- **C4**: 内心的平静 (史诗)

### D类 - 智慧与理解 (4个片段)
对人性和道德的深度理解
- **D1**: 善恶的真相 (稀有)
- **D2**: 人性的复杂 (稀有)
- **D3**: 选择的重量 (史诗)
- **D4**: 内心的声音 (传说)

### E类 - 超越与升华 (4个片段)
超越善恶对立的终极智慧
- **E1**: 超越善恶 (传说)
- **E2**: 内心的和谐 (传说)
- **E3**: 完整的自我 (传说)
- **E4**: 永恒的选择 (传说)

## 记忆触发机制

### 触发条件类型

记忆片段的解锁基于多维度的条件系统：

#### 1. 对话互动条件
- **conversation_count**: 对话轮数要求
- **choice_count**: 总选择次数要求
- **time_played**: 游戏时长要求（分钟）

#### 2. 好感度条件
- **demon_affinity**: 恶魔好感度要求 (0-100)
- **angel_affinity**: 天使好感度要求 (0-100)
- **corruption_value**: 堕落值要求 (0-100)
- **purity_value**: 纯洁值要求 (0-100)

#### 3. 选择行为条件
- **demon_choices**: 恶魔选择次数要求
- **angel_choices**: 天使选择次数要求
- **specific_choices**: 特定选择要求（如 'resist_temptation'）

### 触发机制工作流程

```
用户发送消息
    ↓
检查所有未解锁的记忆片段
    ↓
获取当前会话统计数据
    ↓
遍历每个记忆片段的解锁条件
    ↓
条件检查 (AND逻辑)
    ↓
满足条件 → 解锁记忆片段
    ↓
记录解锁历史
    ↓
返回新解锁的记忆片段
```

### 条件检查逻辑

#### 单一条件检查
每个记忆片段可以包含多个解锁条件，所有条件必须**同时满足**（AND逻辑）才能解锁。

#### 复杂条件支持
系统支持复杂的组合条件，例如：
```json
{
  "demon_affinity": 50,
  "angel_affinity": 30,
  "choice_count": 10
}
```
表示需要恶魔好感度≥50，天使好感度≥30，且总选择次数≥10。

## 记忆解锁示例

### 示例1: A1 - 第一次道德选择
```json
{
  "conversation_count": 5,
  "choice_count": 1
}
```
**触发条件**: 用户进行了至少5轮对话，并做出了至少1次选择
**触发时机**: 早期游戏阶段，引导用户开始思考道德选择

### 示例2: B3 - 堕落的边缘
```json
{
  "corruption_value": 70,
  "demon_choices": 8
}
```
**触发条件**: 堕落值达到70，且选择了8次恶魔建议
**触发时机**: 用户倾向于恶魔选择时的关键节点

### 示例3: E2 - 内心的和谐
```json
{
  "demon_affinity": 80,
  "angel_affinity": 80,
  "corruption_value": 50,
  "purity_value": 50,
  "time_played": 300
}
```
**触发条件**: 恶魔和天使好感度都达到80，堕落值和纯洁值都达到50，游戏时长超过5小时
**触发时机**: 用户达到内心平衡状态的高级阶段

## 稀有度系统

记忆片段按稀有度分为四个等级：

| 稀有度 | 颜色 | 权重 | 描述 |
|--------|------|------|------|
| 普通 (common) | #9CA3AF | 1 | 基础记忆，容易解锁 |
| 稀有 (rare) | #3B82F6 | 2 | 需要一定条件的记忆 |
| 史诗 (epic) | #8B5CF6 | 3 | 重要的心理转折点 |
| 传说 (legendary) | #F59E0B | 4 | 最深层的智慧领悟 |

## 解锁提示系统

### 智能提示生成
系统会根据用户当前状态，生成个性化的解锁提示：

1. **接近解锁**: 当用户接近满足某个记忆片段的条件时，提供具体的行动建议
2. **平衡建议**: 根据当前好感度分布，建议用户尝试不同类型的选择
3. **进度指导**: 显示距离下一个记忆片段解锁还需要什么条件

### 提示示例
- "尝试更多地倾听内心恶魔的声音，你距离解锁新记忆只差3次恶魔选择"
- "保持当前的平衡状态，继续对话15轮即可解锁新的智慧记忆"
- "你的纯洁值已经很高，尝试一些宽恕的选择可能会带来意外收获"

## 数据统计与分析

### 用户进度统计
- **总解锁进度**: 已解锁片段数 / 总片段数
- **分类进度**: 每个类别的解锁情况
- **稀有度分布**: 不同稀有度记忆的解锁数量
- **解锁时间线**: 记忆解锁的时间顺序

### 解锁历史追踪
系统记录每个记忆片段的：
- 解锁时间
- 触发条件
- 解锁时的用户状态
- 查看次数和时间

## 技术实现细节

### 核心服务方法

#### `checkMemoryUnlock()`
主要的记忆解锁检查方法，在每次用户发送消息后调用：
```typescript
async checkMemoryUnlock(
  content: string,
  emotion: any,
  sessionId: string
): Promise<MemoryUnlockResult>
```

#### `checkUnlockConditions()`
检查单个记忆片段的解锁条件：
```typescript
private async checkUnlockConditions(
  conditions: MemoryUnlockCondition[],
  context: UnlockContext
): Promise<boolean>
```

#### `unlockMemoryFragment()`
执行记忆片段解锁操作：
```typescript
async unlockMemoryFragment(
  fragmentId: string,
  sessionId: string,
  unlockType: 'auto' | 'manual',
  reason: string
): Promise<boolean>
```

### 数据库设计

#### memory_fragments 表
存储记忆片段的基础信息

#### unlock_history 表
记录用户的解锁历史

#### 关联查询
通过 LEFT JOIN 查询未解锁的记忆片段

## 游戏设计理念

### 渐进式解锁
记忆片段的设计遵循渐进式解锁原则：
1. **早期**: 简单条件，快速获得成就感
2. **中期**: 复合条件，引导深度思考
3. **后期**: 高难度条件，奖励长期投入

### 心理引导
每个记忆片段都承载着特定的心理引导目的：
- 引发自我反思
- 促进道德思考
- 鼓励内心平衡
- 追求智慧升华

### 个性化体验
通过多维度的条件系统，确保每个用户都能获得独特的解锁体验，反映其个人的选择倾向和成长轨迹。

## 总结

记忆图鉴系统通过精心设计的触发机制，将用户的每一次选择、每一轮对话都转化为心理成长的见证。它不仅是一个游戏机制，更是一面反映用户内心世界的镜子，帮助用户在与AI的对话中探索自我、理解人性、获得智慧。

这个系统的核心价值在于：
1. **记录成长轨迹** - 每个解锁的记忆都是用户心理成长的里程碑
2. **引导深度思考** - 通过条件设计引导用户思考善恶、道德、人性等深层问题
3. **提供个性化反馈** - 根据用户的选择模式提供个性化的心理洞察
4. **创造沉浸体验** - 让用户感受到自己的选择真正影响着游戏世界

通过这样的设计，记忆图鉴系统成功地将抽象的心理概念具象化，让用户在游戏中获得真正的心理成长和智慧启发。